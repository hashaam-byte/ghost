// This is your Prisma schema file
// For more info: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String?   @unique
  name          String?
  avatar        String?
  password      String?   // hashed
  
  // Guest user flag
  isGuest       Boolean   @default(false)
  
  // Subscription
  plan          String    @default("free") // free, pro
  planExpiry    DateTime?
  isStudent     Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  ghostProfile  GhostProfile?
  tasks         Task[]
  notes         Note[]
  streaks       Streak[]
  xpHistory     XPHistory[]
  cryptoPortfolio CryptoPortfolio[]
  gameStats     GameStats[]
  businessData  BusinessData?
  moodLogs      MoodLog[]
  subscription  Subscription?
  usageStats    UsageStats?
  chatMessages  ChatMessage[]
  
  @@map("users")
}

// ============================================
// GHOST AI CORE
// ============================================

model GhostProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Ghost Personality
  personality     String   @default("chill") // chill, funny, strict, motivational, quiet
  tone            String   @default("friendly")
  
  // Ghost XP & Leveling
  totalXP         Int      @default(0)
  level           Int      @default(1)
  xpToNextLevel   Int      @default(100)
  
  // Ghost Evolution
  evolutionStage  Int      @default(1)
  avatarStyle     String   @default("basic")
  
  // User Preferences
  mainFocusAreas  String[] // school, productivity, crypto, gaming, etc.
  timezone        String   @default("Africa/Lagos")
  
  // Behavioral Data
  isMorningPerson Boolean  @default(false)
  procrastinates  Boolean  @default(false)
  motivationStyle String   @default("positive")
  
  // Ghost Room
  roomTheme       String   @default("default")
  roomItems       String[] // unlocked decorations
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("ghost_profiles")
}

// ============================================
// GHOST XP & GAMIFICATION
// ============================================

model XPHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount      Int      // positive or negative
  reason      String   // "completed_task", "studied_30min", "wasted_time"
  category    String   // school, productivity, gaming, crypto, social, etc.
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@map("xp_history")
}

model Streak {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String   // study, sleep, productivity, fitness, crypto
  count       Int      @default(0)
  lastUpdated DateTime @default(now())
  isActive    Boolean  @default(true)
  
  @@unique([userId, type])
  @@index([userId])
  @@map("streaks")
}

// ============================================
// CHAT & CONVERSATIONS
// ============================================

model ChatMessage {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role        String   // user, assistant
  content     String   @db.Text
  
  // Optional metadata
  xpAwarded   Int?
  category    String?  // For context tracking
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@map("chat_messages")
}

// ============================================
// SCHOOL & LEARNING
// ============================================

model Note {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  content     String   @db.Text
  subject     String?
  
  // AI Generated Data
  summary     String?  @db.Text
  keyPoints   String[] // extracted key points
  flashcards  Json?    // auto-generated flashcards
  
  // Media
  imageUrl    String?  // scanned note image
  
  tags        String[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId, createdAt])
  @@index([userId, subject])
  @@map("notes")
}

model HomeworkSolution {
  id          String   @id @default(cuid())
  userId      String
  
  problem     String   @db.Text
  subject     String
  solution    String   @db.Text
  
  xpAwarded   Int      @default(15)
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([userId, subject])
  @@map("homework_solutions")
}

// ============================================
// SCANNING & ANALYSIS
// ============================================

model Scan {
  id            String   @id @default(cuid())
  userId        String
  
  scanType      String   // screenshot, document, general
  description   String   @db.Text
  context       String?  @db.Text
  
  // Analysis results
  analysis      String   @db.Text
  redFlags      String[] // detected issues
  tone          String?  // neutral, suspicious, safe
  recommendation String? @db.Text
  threatLevel   String?  // low, medium, high
  
  xpAwarded     Int      @default(5)
  
  createdAt     DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([userId, scanType])
  @@map("scans")
}

// ============================================
// PRODUCTIVITY
// ============================================

model Task {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String?   @db.Text
  category    String    // school, work, personal, fitness
  priority    String    @default("medium") // low, medium, high
  
  status      String    @default("pending") // pending, in_progress, completed
  
  dueDate     DateTime?
  completedAt DateTime?
  
  // XP Reward
  xpReward    Int       @default(10)
  xpAwarded   Boolean   @default(false) // Track if XP was already given
  
  // Time Blocking
  scheduledAt DateTime?
  duration    Int?      // minutes
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId, status])
  @@index([userId, dueDate])
  @@index([userId, createdAt])
  @@map("tasks")
}

// ============================================
// CRYPTO PORTFOLIO
// ============================================

model CryptoPortfolio {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  coinSymbol  String   // BTC, ETH, SOL
  coinName    String
  amount      Float
  buyPrice    Float
  currentPrice Float?
  
  walletAddress String?
  
  profitLoss  Float?
  profitLossPercent Float?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([userId, coinSymbol])
  @@map("crypto_portfolio")
}

// ============================================
// GAMING
// ============================================

model GameStats {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  gameName    String   // COD Mobile, PUBG, etc.
  
  // Stats
  accuracy    Float?
  kdRatio     Float?
  winRate     Float?
  rank        String?
  
  // Sensitivity
  sensitivity Json?    // recommended settings
  
  lastPlayed  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, gameName])
  @@index([userId])
  @@map("game_stats")
}

// ============================================
// BUSINESS
// ============================================

model BusinessData {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  businessName String?
  businessType String?
  
  revenue     Float    @default(0)
  expenses    Float    @default(0)
  profit      Float    @default(0)
  
  ideas       Json?    // business ideas & analysis
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("business_data")
}

// ============================================
// WELLNESS
// ============================================

model MoodLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  mood        String   // happy, stressed, tired, motivated
  energy      Int      // 1-10
  stress      Int      // 1-10
  
  sleepHours  Float?
  
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@map("mood_logs")
}

// ============================================
// GHOST MEMORY (AI Context)
// ============================================

model GhostMemory {
  id          String   @id @default(cuid())
  userId      String
  
  memoryType  String   // short_term, long_term, behavioral
  content     String   @db.Text
  context     Json?
  
  importance  Int      @default(1) // 1-10
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  
  @@index([userId, memoryType])
  @@index([userId, expiresAt])
  @@map("ghost_memory")
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

model Subscription {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  plan        String   // free, pro
  status      String   @default("active") // active, expired, cancelled
  
  // Billing
  amount      Float?
  currency    String   @default("NGN")
  interval    String?  // month, year
  
  startDate   DateTime @default(now())
  endDate     DateTime?
  
  // Payment
  paymentMethod String?
  lastPaymentDate DateTime?
  nextBillingDate DateTime?
  
  // Student discount
  isStudent   Boolean  @default(false)
  studentVerified Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("subscriptions")
}

model UsageStats {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Daily usage counters (reset at midnight)
  chatCount   Int      @default(0)
  scanCount   Int      @default(0)
  schoolScanCount Int  @default(0)
  
  // Limits
  chatLimit   Int      @default(50)   // Free tier limit
  scanLimit   Int      @default(10)   // Free tier limit
  schoolScanLimit Int  @default(5)    // Free tier limit
  
  lastResetDate DateTime @default(now())
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("usage_stats")
}

model Payment {
  id          String   @id @default(cuid())
  userId      String
  
  amount      Float
  currency    String   @default("NGN")
  
  plan        String   // pro
  interval    String   // month, year
  
  status      String   // pending, success, failed
  
  // Payment gateway data
  reference   String   @unique
  gateway     String   // paystack, flutterwave
  
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([reference])
  @@index([status])
  @@map("payments")
}

// ============================================
// SYNC & OFFLINE SUPPORT
// ============================================

model SyncLog {
  id          String   @id @default(cuid())
  userId      String
  
  entityType  String   // task, note, chat, etc.
  entityId    String
  operation   String   // create, update, delete
  
  data        Json?
  
  synced      Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  syncedAt    DateTime?
  
  @@index([userId, synced])
  @@index([userId, createdAt])
  @@map("sync_logs")
}